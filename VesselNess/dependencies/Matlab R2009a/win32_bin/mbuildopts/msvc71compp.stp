# $Revision: 1.1.6.5 $

use msvc_modules_installer;

sub msvc71compp 
{
    my $input = shift;
    my $default_location = "C:\\Program Files\\Microsoft Visual Studio .NET 2003";
    my $specified_compiler_location = "";
    my @language_handled = ('C','CPP','COM');
    my $locate_fcn = sub {
        my @msvc7_roots = ();
        my $msvc7_root;
        my $registry_lookup_fcn = $input->{"registry_lookup"};

        if ($ENV{'VS71COMNTOOLS'} ne "" &&
            -e "$ENV{'VS71COMNTOOLS'}\\..\\..\\Vc7\\bin\\cl.exe") {
            $msvc7_root = $ENV{'VS71COMNTOOLS'}; 
            $msvc7_root =~ s|\\+Common7\\+Tools\\*$||i;
            $oldPath = $ENV{'PATH'};
            $ENV{'PATH'} = "$msvc7_root\\Common7\\IDE;$oldPath";
            if (&correct_version("$msvc7_root\\Vc7\\bin\\cl.exe","13.1")) { 
                push(@msvc7_roots, $msvc7_root); 
            }
            $ENV{'PATH'} = "$oldPath";
        }

        $msvc7_root = &$registry_lookup_fcn("SOFTWARE\\Microsoft\\VisualStudio\\7.1\\" . 
                                            "Setup\\VC", "ProductDir");

        if (-e "$msvc7_root\\bin\\cl.exe")
        {
            $msvc7_root =~ s|\\Vc7\\$||i;
            push(@msvc7_roots, $msvc7_root);
        }

        if (-e "$default_location")
        {
            push(@msvc7_roots, $default_location);
        }

        return @msvc7_roots;
    };

    my $root_val = sub {
        my $base_directory = shift;

        $specified_compiler_location = $base_directory; # Remember this for post_setup_hook
        if (!-d "$base_directory\\Vc7" || !-d "$base_directory\\Common7")
        {       
            print "Warning: MBUILD requires that the Microsoft Visual C++ 7.1\n" .
                  "directories \"Vc7\" and \"Common7\" be located within the same parent " .
                  "directory.\n(Expected to find these directories in '$base_directory'.)";
        }

        return $base_directory;
    };

    return {
        "vendor_name"  => "Microsoft Visual C++ .NET 2003",
        "version"      => "",                               #This version is left blank intentionally.
        "group_id"     => "MSVC",
        "serial"       => 5.0,
        "root_var"     => "VSINSTALLDIR",
        "optfile_name" => "msvc71compp.bat",
        "default_location" => $default_location,
        "language_handled" => \@language_handled,
        "root_val"         => $root_val,
        "locate"           => $locate_fcn,
        "post_setup_hook"  => $post_setup_hook,
        "maxOSVersionSupported"    => "5",
        "minOSVersionSupported"    => "5",
        };
}
1;
